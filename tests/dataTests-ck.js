function clearLocalStorage(){localStorage.clear()}module("ScukMap.model.DataLocalStorage");test("setItem",function(){log("running test: setItem");expect(3);clearLocalStorage();var e=new ScukMap.model.DataLocalStorage,t="fadfasdfa",n="fadfasdfa sdfasdfa dsfa dsfasdfa";e.setItem(t,n);var r=e.getItem(t);strictEqual(n,r,"dataFrom, dataTo the same");t="12-15-12-15";n="fadfasdfaa fasdf asdfa sdfasd asdfads sdfasdfa dsfa dsfasdfa";e.setItem(t,n);r=e.getItem(t);strictEqual(n,r,"dataFrom, dataTo the same");t=";'..//";n="fadfasd'fadsfadsasdfasdfasdfasd";e.setItem(t,n);r=e.getItem(t);strictEqual(n,r,"dataFrom, dataTo the same")});test("setItem with clearing storage",function(){log("running test: setItem with clearing storage");expect(1);clearLocalStorage();var e=new ScukMap.model.DataLocalStorage,t="fadfasdfa",n="fadfasdfa sdfasdfa dsfa dsfasdfa";e.setItem(t,n);clearLocalStorage();var r=e.getItem(t);notStrictEqual(n,r,"dataFrom, dataTo not the same")});test("overflow local storage",function(){log("running test: overflow local storage");expect(1);clearLocalStorage();var e=new ScukMap.model.DataLocalStorage,t=2e3;for(var n=0;n<t;n++){var r=n+"ffřěžýáířěfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčřfřěžýáířěš+ýř+íěšř=ý+ěíšáéřý+šěíř+éěšříáý+šěř+šěéříá+ýěšř+ěšéíářý+ěšř+ěšěščřěčřěčšřěščřěščřěčšřěčšřěčřěčř"+n,i=n,s=e.setItem(i,r);if(s==="QuotaExceededError"){ok(!0,"quota overexceeded");return}}});module("ScukMap.model.DataCache");var dataDump=[{address:"address_0",description:"description_0",id:"157",level:2,name:"name157",point:[15.413972208,49.7980589284],satisfaction:1,score:1,type:"1:restaurace:Restaurace",url:"157",web:"url_0"},{address:"address_1",description:"description_1",id:"1558",level:2,name:"name1558",point:[15.3482793213,49.7454445142],satisfaction:1,score:1,type:"1:restaurace:Restaurace",url:"1558",web:"url_1"},{address:"address_2",description:"description_2",id:"2641",level:2,name:"name2641",point:[15.4140894624,49.7981963683],satisfaction:1,score:1,type:"1:restaurace:Restaurace",url:"2641",web:"url_2"}];test("basic datacache",function(){log("running test: basic datacache");expect(5);clearLocalStorage();var e=new ScukMap.model.DataCache;e.init();ok(e.cache,"runtime cache exists");ok(e.localStorage,"local storage exists");var t=dataDump,n=234,r=324,i=3;e.startNewStorage();e.store(t,n,r,i);var s=e.get(n,r,i);strictEqual(t,s,"dataFrom, dataTo the same");var o=e.constructKey(n,r,i),u=e.localStorage.getTile(o);deepEqual(u,t,"data in local storage correct");var a=e.cache[o];strictEqual(a,t,"data in local storage correct")});test("basic datacache with clearing",function(){log("running test: basic datacache with clearing");expect(3);clearLocalStorage();var e=new ScukMap.model.DataCache;e.init();var t="fadfasdfa",n=dataDump,r=234,i=324,s=3;e.startNewStorage();e.store(n,r,i,s);e.endNewStorage();e.clear();var o=e.get(r,i,s);strictEqual(undefined,o,"dataFrom is null");e.startNewStorage();e.store(n,r,i,s);e.endNewStorage();e.clear(!0,!1);var u=e.constructKey(r,i,s),a=e.localStorage.getTile(u);deepEqual(a,n,"data in local storage correct");var f=e.cache[u];strictEqual(f,undefined,"data runtime cache is null")});module("ScukMap.model.DataProxy");asyncTest("getDataFromServer without cache",function(){function o(e){strictEqual(r,e.length,"all markers returned");var t=Math.floor(Math.random()*e.length),n=e[t];ok(n.hasOwnProperty("address"),"address ok");ok(n.hasOwnProperty("description"),"description ok");ok(n.hasOwnProperty("level"),"level ok");ok(n.hasOwnProperty("point"),"point ok");ok(n.hasOwnProperty("url"),"url ok");var i=n.point;ok(!isNaN(parseFloat(i[0]))&&!isNaN(parseFloat(i[1])),"point values ok");var s=ScukMap.utils.DataUtil.parseMarkerType(n.type);ok(s.length>0,"marker type found");ok(!isNaN(parseFloat(s[0])),"marker type is number");start()}log("running test: getDataFromServer without cache");expect(9);var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=0,n="../php/getDataByTiles.php",r=4126,i={url:n,method:"GET",withCache:!1,dataVersion:.1},s=new ScukMap.model.DataProxy(i);s.init();s.getDataFromServer(o,e)});asyncTest("getData without cache",function(){function a(e){strictEqual(s,e.length,"all markers returned");var t=Math.floor(Math.random()*e.length),n=e[t];ok(n.hasOwnProperty("address"),"address ok");ok(n.hasOwnProperty("description"),"description ok");ok(n.hasOwnProperty("level"),"level ok");ok(n.hasOwnProperty("point"),"point ok");ok(n.hasOwnProperty("url"),"url ok");var r=n.point;ok(!isNaN(parseFloat(r[0]))&&!isNaN(parseFloat(r[1])),"point values ok");var i=ScukMap.utils.DataUtil.parseMarkerType(n.type);ok(i.length>0,"marker type found");ok(!isNaN(parseFloat(i[0])),"marker type is number");start()}log("running test: getData without cache");expect(9);var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=null,n=null,r=0,i="../php/getDataByTiles.php",s=4126,o={url:i,method:"GET",withCache:!1,dataVersion:.1},u=new ScukMap.model.DataProxy(o);u.init();u.getData(a,0,e)});asyncTest("getData with cache",function(){function u(e){var t=e.length,n=o.dataCache.cache,r=0;for(var i in n){var s=n[i],u=s.length;for(var a=0;a<u;a++)r++}strictEqual(t,r,"everything in runtime cache");var f=[];for(i in n)f=f.concat(o.dataCache.localStorage.getItem(i));strictEqual(t,f.length,"everything in local storage");start()}log("running test: getData with cache");expect(3);var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=null,n=null,r=0,i="../php/getDataByTiles.php",s={url:i,method:"GET",withCache:!0,dataVersion:.1},o=new ScukMap.model.DataProxy(s);o.init();o.dataCache.clear();ok(o.dataCache,"datacache exists");o.getData(u,0,e)});asyncTest("check uniqnuess of data",function(){function s(n){var r=n.length,s=i.dataCache.cache,o=0,u=[],a=!0;for(var f in e){var l=e[f],c=i.dataCache.constructKey(l.x,l.y,t),h=i.dataCache.localStorage.getItem(c),r=h.length;for(var p=0;p<r;p++){var d=h[p];if(!!u[d]){log("already presnet id",d);a=!1;break}u[d]=!0}for(var v=0;v<n.length;v++){var m=n[v];m.web=="url_980"&&log(m)}}ok(a,"all stored ids are present only once (in one tile)");start()}log("running test: check uniqnuess of data");expect(1);clearLocalStorage();var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=0,n="../php/getDataByTiles.php",r={url:n,method:"GET",withCache:!0,dataVersion:.1},i=new ScukMap.model.DataProxy(r);i.init();i.dataCache.clear();i.getData(s,0,e)});asyncTest("check same dataVersion",function(){function a(e){var t=u.dataCache.cache;for(var n in t)s.push(n);u=new ScukMap.model.DataProxy(o);u.init();var i=u.dataCache,a=s[Math.floor(s.length*Math.random())],f=a.split("-"),l=parseInt(f[0]),c=parseInt(f[1]),h=i.get(l,c,r);ok(h,"there shoud be data in the local storage");start()}log("running test: check dataVersion");expect(1);var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=null,n=null,r=0,i="../php/getDataByTiles.php",s=[],o={url:i,method:"GET",withCache:!0,dataVersion:.1};clearLocalStorage();var u=new ScukMap.model.DataProxy(o);u.init();u.getData(a,0,e)});asyncTest("check different dataVersion",function(){function a(e){var t=u.dataCache.cache;for(var n in t)s.push(n);o.dataVersion=.1;u=new ScukMap.model.DataProxy(o);u.init();var i=u.dataCache,a=s[Math.floor(s.length*Math.random())];log("randomKey",a);var f=a.split("-"),l=parseInt(f[0]),c=parseInt(f[1]),h=i.get(l,c,r);equal(h,null,"there shoudln't be anything in the local storage");start()}log("running test: check dataVersion");expect(1);var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=null,n=null,r=0,i="../php/getDataByTiles.php",s=[],o={url:i,method:"GET",withCache:!0,dataVersion:.1},u=new ScukMap.model.DataProxy(o);u.init();u.dataCache.clear();u.getData(a,0,e)});asyncTest("check different dataVersion",function(){function a(e){var t=u.dataCache.cache;for(var n in t)s.push(n);o.dataVersion=.1;u=new ScukMap.model.DataProxy(o);u.init();var i=u.dataCache,a=s[Math.floor(s.length*Math.random())],f=a.split("-"),l=parseInt(f[0]),c=parseInt(f[1]),h=i.get(l,c,r);equal(h,null,"there shoudln't be anything in the local storage");start()}log("running test: check dataVersion");expect(1);var e=[{x:138,y:86},{x:139,y:86},{x:138,y:87},{x:139,y:87}],t=null,n=null,r=0,i="../php/getDataByTiles.php",s=[],o={url:i,method:"GET",withCache:!0,dataVersion:.1},u=new ScukMap.model.DataProxy(o);u.init();u.dataCache.clear();u.getData(a,0,e)});